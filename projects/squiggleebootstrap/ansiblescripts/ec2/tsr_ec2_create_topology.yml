- hosts: localhost
  connection: local
  gather_facts: True
  vars:
    ec2_access_key: "AKIAIQWKLMSGKA7YCSLA"
    ec2_secret_key: "PiFhUX0D6sh863fS9Bd0kRYeFKeq1YpjfV+a7Cil"
    keypair: "ec2tsrserver"    
    cluster: "TSR_EC2_CLUST"
# Example create topology for one region 1 server deployment i2.xlarge --> ami-1ecae776 (
# topology: [{"instance_type":"c4.2xlarge","image":"ami-76817c1e","group":"awtsrserver1","region":"us-east-1","zone":"us-east-1a","vpc_subnet_id":"subnet-575b9520","token":"0","ring_position":"0","is_seed":"yes","is_bootstrap_node":"yes","Name":"TimeSeriesNode_0","replica_of":"0","storage":"250","stype":"Small"}]
#    topology: [{"cluster":"Cluster1","instance_type":"i2.xlarge","image":"ami-1ecae776","group":"awtsrserver1","region":"us-east-1","zone":"us-east-1a","vpc_subnet_id":"subnet-575b9520","token":"0","ring_position":"0","is_seed":"yes","is_bootstrap_node":"yes","Name":"TimeSeriesNode_0","replica_of":"0","storage":"800","stype":"Medium"}]
#    topology: [
#      {"instance_type":"m3.large","image":"ami-1ecae776","group":"awtsrserver1","region":"us-east-1","zone":"us-east-1a","vpc_subnet_id":"subnet-575b9520","token":"0","ring_position":"0","is_seed":"yes","is_bootstrap_node":"yes","Name":"TimeSeriesNode_0","replica_of":"0","storage":"800","stype":"Medium"},
#      {"instance_type":"m3.large","image":"ami-1ecae776","group":"awtsrserver1","region":"us-east-1","zone":"us-east-1a","vpc_subnet_id":"subnet-575b9520","token":"1000000","ring_position":"1","is_seed":"yes","is_bootstrap_node":"no","Name":"TimeSeriesNode_1","replica_of":"0","storage":"800","stype":"Medium"},
#      {"instance_type":"m3.large","image":"ami-1ecae776","group":"awtsrserver1","region":"us-east-1","zone":"us-east-1a","vpc_subnet_id":"subnet-575b9520","token":"2000000","ring_position":"2","is_seed":"no","is_bootstrap_node":"no","Name":"TimeSeriesNode_2","replica_of":"0","storage":"800","stype":"Medium"},
#      {"instance_type":"m3.large","image":"ami-1ecae776","group":"awtsrserver1","region":"us-east-1","zone":"us-east-1a","vpc_subnet_id":"subnet-575b9520","token":"3000000","ring_position":"3","is_seed":"yes","is_bootstrap_node":"no","Name":"TimeSeriesNode_3","replica_of":"3","storage":"800","stype":"Medium"},
#      {"instance_type":"m3.large","image":"ami-1ecae776","group":"awtsrserver1","region":"us-east-1","zone":"us-east-1a","vpc_subnet_id":"subnet-575b9520","token":"4000000","ring_position":"4","is_seed":"no","is_bootstrap_node":"no","Name":"TimeSeriesNode_4","replica_of":"3","storage":"800","stype":"Medium"}
#    ]
  tasks:
    - name: Launch Topology 
      ec2: 
        image: "{{ item['image'] }}" 
        instance_type: "{{ item['instance_type'] }}" 
        aws_access_key: "{{ ec2_access_key }}" 
        aws_secret_key: "{{ ec2_secret_key }}" 
        keypair: "{{ keypair }}" 
        instance_tags: {"cluster":"{{ item['cluster'] }}","token":"{{ item['token'] }}","ring_position":"{{ item['ring_position'] }}","is_seed":"{{ item['is_seed'] }}","is_bootstrap_node":"{{ item['is_bootstrap_node'] }}","replica_of":"{{ item['replica_of'] }}","Name":"{{ item['Name'] }}","storage":"{{ item['storage'] }}","stype":"{{ item['stype'] }}"} 
        region: "{{ item['region'] }}" 
        volumes:
          - device_name: /dev/xvdb
            ephemeral: ephemeral0
        vpc_subnet_id: "{{ item['vpc_subnet_id'] }}" 
        group: "{{ item['group'] }}" 
        count: 1 
        wait: True 
      with_items: topology
      register: created 
    - name: Wait for SSH to come up
      wait_for: host={{ item.public_ip }} port=22 delay=20 timeout=320 state=started
      with_items: created.results[0].instances
    - name: Refresh dynamic inventory cache 
      local_action: command python hosts/ec2.py --refresh-cache