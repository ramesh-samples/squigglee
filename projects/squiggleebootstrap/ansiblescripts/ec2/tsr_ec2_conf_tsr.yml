#- hosts: localhost
#  connection: local
#  gather_facts: True    
#  tasks:
#    - name: Refresh dynamic inventory cache 
#      local_action: command hosts/ec2.py --refresh-cache
#    - name: Refresh seed list
#      local_action: shell hosts/ec2.py --list | python seeds.py
#- hosts: ec2 
- hosts: tag_ring_position_{{logicalNumber}}:&tag_cluster_{{cluster}}
  gather_facts: True
  user: ec2-user 
  vars:
    ec2_access_key: "AKIAIQWKLMSGKA7YCSLA"
    ec2_secret_key: "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"
    jboss_version: "jboss-as-7.1.1.Final"
    security_group: '{{hostvars[inventory_hostname]["ec2_security_group_names"]}}'
    cluster: "TSR_EC2_CLUST"
  tasks:
    - debug: msg="Configuring Time Series Repository at Logical Node = {{logicalNumber}}"
# Configure Application 
    - copy: force=yes src="./modules/com/squigglee" dest="/opt/{{ jboss_version }}/modules/com"  owner="ec2-user" group="ec2-user" mode="0644"
      sudo: yes 
    - copy: force=yes src="./modules/org/apache/zookeeper" dest="/opt/{{ jboss_version }}/modules/org/apache"  owner="ec2-user" group="ec2-user" mode="0644"
      sudo: yes            
    - copy: force=yes src="./modules/com/google/gson" dest="/opt/{{ jboss_version }}/modules/com/google"  owner="ec2-user" group="ec2-user" mode="0644"
      sudo: yes 
    - copy: force=yes src="./modules/org/apache/avro" dest="/opt/{{ jboss_version }}/modules/org/apache" owner="ec2-user" group="ec2-user" mode="0644" 
      sudo: yes 
    - copy: force=yes src="./modules/org/joda/time" dest="/opt/{{ jboss_version }}/modules/org/joda" owner="ec2-user" group="ec2-user" mode="0644" 
      sudo: yes 
    - copy: force=yes src="./modules/org/apache/commons/math" dest="/opt/{{ jboss_version }}/modules/org/apache/commons" owner="ec2-user" group="ec2-user" mode="0644" 
      sudo: yes 
    - copy: force=yes src="./modules/org/apache/commons/lang3" dest="/opt/{{ jboss_version }}/modules/org/apache/commons" owner="ec2-user" group="ec2-user" mode="0644" 
      sudo: yes 
    - copy: force=yes src="./standalone-teiid_master.xml" dest="/opt/{{ jboss_version }}/standalone/configuration/standalone-teiid.xml"  owner="ec2-user" group="ec2-user" mode="0644"
    - copy: force=yes src="./TIMESERIES-vdb_master.xml" dest="/opt/{{ jboss_version }}/standalone/deployments/TIMESERIES-vdb.xml"  owner="ec2-user" group="ec2-user" mode="0644"
    - copy: force=yes src="./TimeSeriesH2Script.sql" dest="/opt/{{ jboss_version }}/standalone/configuration/TimeSeriesH2Script.sql"  owner="ec2-user" group="ec2-user" mode="0644"
    - lineinfile: insertafter="<datasources>" dest="/opt/{{ jboss_version }}/standalone/configuration/standalone-teiid.xml" state=present line='<datasource jndi-name="java:/TimeSeriesVDB_{{hostvars[item]["ec2_tag_cluster"]}}_{{hostvars[item]["ec2_tag_ring_position"]}}" pool-name="TimeSeriesVDB_{{hostvars[item]["ec2_tag_ring_position"]}}" enabled="true"><connection-url>jdbc:teiid:TIMESERIES@mm://{{hostvars[item]["ec2_ip_address"]}}:31000</connection-url><driver>teiid</driver><security><user-name>user</user-name><password>tsruserpw</password></security></datasource>'
      when: ( "{{hostvars[item]["ec2_tag_cluster"]}}" == "{{cluster}}" )
      with_items: groups['security_group_{{security_group}}']
    - stat: path="/opt/tsr/services" 
      register: servicesdir 
      sudo: yes 
    - command: "sudo mkdir -p /opt/tsr/services" 
      when: servicesdir.stat.isdir is not defined or servicesdir.stat.isdir != true
    - copy: force=yes src="./lib" dest="/opt/tsr/services"  owner="ec2-user" group="ec2-user" mode="0644"
      sudo: yes           
    - copy: force=yes src="./squiggleejobs.jar" dest="/opt/tsr/services/squiggleejobs.jar"  owner="ec2-user" group="ec2-user" mode="0644"
      sudo: yes
    - copy: force=yes src="./squiggleeclient.jar" dest="/opt/tsr/services/squiggleeclient.jar"  owner="ec2-user" group="ec2-user" mode="0644"
      sudo: yes 
    - copy: force=yes src="./log4j_tasks_master.properties" dest="/opt/tsr/services/log4j.properties"  owner="ec2-user" group="ec2-user" mode="0644"
      sudo: yes
    - copy: force=yes src="./LocalNodeProperties_master.config" dest="/opt/tsr/services/LocalNodeProperties.config"  owner="ec2-user" group="ec2-user" mode="0644"
      sudo: yes
    - lineinfile: dest=/opt/tsr/services/LocalNodeProperties.config state=present backrefs=yes regexp='^clusterName' line='clusterName{{"="}}{{cluster}}' 
      sudo: yes       
    - lineinfile: dest=/opt/tsr/services/LocalNodeProperties.config state=present backrefs=yes regexp='^clusterPort' line='clusterPort{{"="}}9160' 
      sudo: yes
    - lineinfile: dest=/opt/tsr/services/LocalNodeProperties.config state=present backrefs=yes regexp='^logicalNumber' line='logicalNumber{{"="}}{{hostvars[inventory_hostname]["ec2_tag_ring_position"]}}' 
      sudo: yes
    - lineinfile: dest=/opt/tsr/services/LocalNodeProperties.config state=present backrefs=yes regexp='^serializerType' line="serializerType{{'='}}AVRO" 
      sudo: yes       
    - lineinfile: dest=/opt/tsr/services/LocalNodeProperties.config state=present backrefs=yes regexp='^overlayTimerInterval' line="overlayTimerInterval{{'='}}20" 
      sudo: yes       
    - lineinfile: dest=/opt/tsr/services/LocalNodeProperties.config state=present backrefs=yes regexp='^vdbFile' line="vdbFile{{'='}}/opt/{{ jboss_version }}/standalone/deployments/TIMESERIESGLOBAL-vdb.xml" 
      sudo: yes       
    - lineinfile: dest=/opt/tsr/services/LocalNodeProperties.config state=present backrefs=yes regexp='^pingTimerInterval' line="pingTimerInterval{{'='}}30" 
      sudo: yes       
    - lineinfile: dest=/opt/tsr/services/LocalNodeProperties.config state=present backrefs=yes regexp='^addr' line="addr{{'='}}{{hostvars[inventory_hostname]["ec2_ip_address"]}}" 
      sudo: yes 
    - lineinfile: dest=/opt/tsr/services/LocalNodeProperties.config state=present backrefs=yes regexp='^id' line="id{{'='}}{{hostvars[inventory_hostname]["ec2_id"]}}" 
      sudo: yes 
    - lineinfile: dest=/opt/tsr/services/LocalNodeProperties.config state=present backrefs=yes regexp='^dc' line="dc{{'='}}{{hostvars[inventory_hostname]["ec2_region"]}}" 
      sudo: yes       
    - lineinfile: dest=/opt/tsr/services/LocalNodeProperties.config state=present backrefs=yes regexp='^name' line="name{{'='}}{{hostvars[inventory_hostname]["ec2_tag_Name"]}}" 
      sudo: yes       
    - lineinfile: dest=/opt/tsr/services/LocalNodeProperties.config state=present backrefs=yes regexp='^isBoot' line="isBoot{{'='}}{{hostvars[inventory_hostname]["ec2_tag_is_bootstrap_node"]}}" 
      sudo: yes       
    - lineinfile: dest=/opt/tsr/services/LocalNodeProperties.config state=present backrefs=yes regexp='^isSeed' line="isSeed{{'='}}{{hostvars[inventory_hostname]["ec2_tag_is_seed"]}}" 
      sudo: yes     
    - lineinfile: dest=/opt/tsr/services/LocalNodeProperties.config state=present backrefs=yes regexp='^replicaOf' line="replicaOf{{'='}}{{hostvars[inventory_hostname]["ec2_tag_replica_of"]}}" 
      sudo: yes 
    - lineinfile: dest=/opt/tsr/services/LocalNodeProperties.config state=present backrefs=yes regexp='^storage' line="storage{{'='}}{{hostvars[inventory_hostname]["ec2_tag_storage"]}}" 
      sudo: yes 
    - lineinfile: dest=/opt/tsr/services/LocalNodeProperties.config state=present backrefs=yes regexp='^stype' line="stype{{'='}}{{hostvars[inventory_hostname]["ec2_tag_stype"]}}" 
      sudo: yes 
    - lineinfile: dest=/opt/tsr/services/LocalNodeProperties.config state=present backrefs=yes regexp='^localDataCenter' line="localDataCenter{{'='}}us-east"
      when: ('{{hostvars[inventory_hostname]["ec2_region"]}}' == 'us-east-1')
      sudo: yes
    - lineinfile: dest=/opt/tsr/services/LocalNodeProperties.config state=present backrefs=yes regexp='^localDataCenter' line="localDataCenter{{'='}}us-west"
      when: ('{{hostvars[inventory_hostname]["ec2_region"]}}' == 'us-west-1')
      sudo: yes
    - lineinfile: dest=/opt/tsr/services/LocalNodeProperties.config state=present backrefs=yes regexp='^localDataCenter' line="localDataCenter{{'='}}us-west-2"
      when: ('{{hostvars[inventory_hostname]["ec2_region"]}}' == 'us-west-2')
      sudo: yes
    - lineinfile: dest=/opt/tsr/services/LocalNodeProperties.config state=present backrefs=yes regexp='^localDataCenter' line="localDataCenter{{'='}}eu-west"
      when: ('{{hostvars[inventory_hostname]["ec2_region"]}}' == 'eu-west-1')
      sudo: yes    
    - lineinfile: dest=/opt/tsr/services/LocalNodeProperties.config state=present backrefs=yes regexp='^localDataCenter' line="localDataCenter{{'='}}eu-central"
      when: ('{{hostvars[inventory_hostname]["ec2_region"]}}' == 'eu-central-1')
      sudo: yes  
    - lineinfile: dest=/opt/tsr/services/LocalNodeProperties.config state=present backrefs=yes regexp='^localDataCenter' line="localDataCenter{{'='}}ap-northeast"
      when: ('{{hostvars[inventory_hostname]["ec2_region"]}}' == 'ap-northeast-1')
      sudo: yes       
    - lineinfile: dest=/opt/tsr/services/LocalNodeProperties.config state=present backrefs=yes regexp='^localDataCenter' line="localDataCenter{{'='}}ap-southeast"
      when: ('{{hostvars[inventory_hostname]["ec2_region"]}}' == 'ap-southeast-1')
      sudo: yes    
    - lineinfile: dest=/opt/tsr/services/LocalNodeProperties.config state=present backrefs=yes regexp='^localDataCenter' line="localDataCenter{{'='}}ap-southeast-2"
      when: ('{{hostvars[inventory_hostname]["ec2_region"]}}' == 'ap-southeast-2')
      sudo: yes   
    - lineinfile: dest=/opt/tsr/services/LocalNodeProperties.config state=present backrefs=yes regexp='^localDataCenter' line="localDataCenter{{'='}}sa-east"
      when: ('{{hostvars[inventory_hostname]["ec2_region"]}}' == 'sa-east-1')
      sudo: yes
    - lineinfile: insertbefore="# Display our environment" dest="/opt/{{ jboss_version }}/bin/standalone.sh" state=present line='JAVA_OPTS="$JAVA_OPTS -Xms2048m -Xmx4096m"'
      sudo: yes
    - copy: force=yes src="./lib/squiggleewebui.war" dest="/opt/{{ jboss_version }}/standalone/deployments/squiggleewebui.war"  owner="ec2-user" group="ec2-user" mode="0644"
      sudo: yes 
    - copy: force=yes src="./lib/squiggleerestui.war" dest="/opt/{{ jboss_version }}/standalone/deployments/squiggleerestui.war"  owner="ec2-user" group="ec2-user" mode="0644"
      sudo: yes 


