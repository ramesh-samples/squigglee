#- hosts: localhost
#  connection: local
#  gather_facts: True    
#  tasks:
#    - name: Refresh dynamic inventory cache 
#      local_action: command hosts/ec2.py --refresh-cache
#    - name: Refresh seed list
#      local_action: shell hosts/ec2.py --list | python seeds.py 
#- hosts: ec2 
- hosts: tag_ring_position_{{logicalNumber}}:&tag_cluster_{{cluster}}
  gather_facts: True
  user: ec2-user 
  vars:
    ec2_access_key: "AKIAIQWKLMSGKA7YCSLA"
    ec2_secret_key: "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"
    cluster: "TSR_EC2_CLUST"
    rpmfile: "jdk-7u67-linux-x64.rpm"
#    rpmfile: "jdk-8u60-linux-x64.rpm"
#    jdk_url: "http://download.oracle.com/otn-pub/java/jdk/7u67-b01/jdk-7u67-linux-x64.rpm"
    jdk_version: "jdk1.7.0_67"
#    jdk_version: "jdk1.8.0_60"
  tasks:      
    - debug: msg="Configuring Pre-requisites at Logical Node = {{logicalNumber}}"
#    - debug: var=logicalNumber
    - command: sudo yum -y update 
    - command: sudo yum -y install sysstat 
    - stat: path="/usr/java/{{ jdk_version }}/bin" 
      register: java 
      sudo: yes 
    - debug: var=java
#    - command: > 
#         wget --no-check-certificate --no-cookies --header "Cookie: oraclelicense=accept-securebackup-cookie" {{ jdk_url }}
#      when: (java.stat.isdir is not defined or java.stat.isdir != true)
    - copy: src="./{{ rpmfile }}" dest="/home/ec2-user" force="yes" owner="ec2-user" group="ec2-user" mode="0744"
    - command: sudo rpm -i {{ rpmfile }} 
      when: (java.stat.isdir is not defined or java.stat.isdir != true)
    - shell: 'sudo update-alternatives --install "/usr/bin/java" "java" "/usr/java/{{ jdk_version }}/bin/java" 1' 
      when: (java.stat.isdir is not defined or java.stat.isdir != true)
    - shell: 'sudo update-alternatives --set java /usr/java/{{ jdk_version }}/bin/java' 
      when: (java.stat.isdir is not defined or java.stat.isdir != true)
    - lineinfile: dest=/home/ec2-user/.bash_profile line='export JAVA_HOME=/usr/java/{{ jdk_version }}' state=present
      when: (java.stat.isdir is not defined or java.stat.isdir != true)
    - lineinfile: dest=/home/ec2-user/.bash_profile line='export PATH=$PATH:/usr/java/{{ jdk_version }}/bin' state=present 
      when: (java.stat.isdir is not defined or java.stat.isdir != true)
    - lineinfile: dest=/etc/security/limits.conf line='root soft memlock unlimited' state=present
      when: (java.stat.isdir is not defined or java.stat.isdir != true)
      sudo: yes  
    - lineinfile: dest=/etc/security/limits.conf line='root hard memlock unlimited' state=present 
      when: (java.stat.isdir is not defined or java.stat.isdir != true)
      sudo: yes 
    - lineinfile: dest=/etc/security/limits.conf line='root soft nofile 2000000' state=present
      when: (java.stat.isdir is not defined or java.stat.isdir != true)
      sudo: yes  
    - lineinfile: dest=/etc/security/limits.conf line='root hard nofile 2000000' state=present
      when: (java.stat.isdir is not defined or java.stat.isdir != true)
      sudo: yes   
#    - lineinfile: dest=/etc/sudoers regexp='(requiretty)*' line='Defaults    !requiretty' state=present
#      when: (java.stat.isdir is not defined or java.stat.isdir != true)
#      sudo: yes 
#    - lineinfile: dest=/home/ec2-user/.bash_profile line='export tsrPropFile=/opt/tsr/services/LocalNodeProperties.config' state=present      
#    - lineinfile: dest=/etc/sysctl.conf line='fs.file-max = 2000000' state=present
#      sudo: yes 
#      when: (java.stat.isdir is not defined or java.stat.isdir != true)
#    - command: sudo sysctl -p 
#      when: (java.stat.isdir is not defined or java.stat.isdir != true)
#    - command: sudo rm -f {{ rpmfile }} 

