#- hosts: localhost
#  connection: local
#  gather_facts: True    
#  tasks:
#    - name: Refresh dynamic inventory cache 
#      local_action: command hosts/ec2.py --refresh-cache
#    - name: Refresh seed list
#      local_action: shell hosts/ec2.py --list | python seeds.py
#- hosts: ec2 
- hosts: tag_ring_position_{{logicalNumber}}:&tag_cluster_{{cluster}}
  gather_facts: True
  user: ec2-user 
  vars:
    ec2_access_key: "AKIAIQWKLMSGKA7YCSLA"
    ec2_secret_key: "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"
    cluster: "TSR_EC2_CLUST"
    dataVolName: "/data"
    logVolName: "/log"
    jboss_server: "http://download.jboss.org/jbossas/7.1/jboss-as-7.1.1.Final/"
    jboss_version: "jboss-as-7.1.1.Final"
    jboss_file: "jboss-as-7.1.1.Final.zip"
    teiid_server: "http://sourceforge.net/projects/teiid/files/teiid/8.3/Final/"
    teiid_file: "teiid-8.3.0.Final-jboss-dist.zip" 
  tasks:
    - debug: msg="Configuring JBOSS and TEIID at Logical Node = {{logicalNumber}}"  
# Configure Teiid 
    - stat: path="/opt/{{ jboss_version }}" 
      register: jboss 
      sudo: yes 
#    - debug: var=jboss 
#    - command: "sudo wget {{ jboss_server }}{{ jboss_file }} creates={{ jboss_file }}"
#      when: (jboss.stat.isdir is not defined or jboss.stat.isdir != true)
    - copy: src="./jboss-as-7.1.1.Final.zip" dest="/home/ec2-user" force="yes" owner="ec2-user" group="ec2-user" mode="0744"  
    - command: "sudo unzip {{ jboss_file }} " 
      when: (jboss.stat.isdir is not defined or jboss.stat.isdir != true) 
    - command: "sudo mv {{ jboss_version }} /opt "
      when: (jboss.stat.isdir is not defined or jboss.stat.isdir != true) 
    - stat: path="/opt/{{ jboss_version }}/modules/org/jboss/teiid" 
      register: teiid 
      sudo: yes  
#    - command: "sudo wget {{ teiid_server }}{{ teiid_file }} creates={{ teiid_file }}"
#      when: teiid.stat.isdir is not defined or teiid.stat.isdir != true
    - copy: src="./teiid-8.3.0.Final-jboss-dist.zip" dest="/home/ec2-user" force="yes" owner="ec2-user" group="ec2-user" mode="0744"
    - command: "sudo unzip -d /opt/{{ jboss_version }} -o {{ teiid_file }} " 
      when: (teiid.stat.isdir is not defined or teiid.stat.isdir != true)
    - command: sudo chown -R ec2-user:ec2-user /opt/{{ jboss_version }}
      when: (teiid.stat.isdir is not defined or teiid.stat.isdir != true)
    - lineinfile: dest=/etc/hosts line='127.0.0.1 {{ hostvars[inventory_hostname]['ansible_nodename'] }} {{ hostvars[inventory_hostname]['ec2_private_dns_name'] }}' state=present
      sudo: yes 
    - lineinfile: dest=/opt/{{ jboss_version }}/standalone/configuration/mgmt-users.properties backrefs=yes regexp='^tsradmin' line='tsradmin=361a4e63c292c27d0dec7afd1e1a4b41' state=present
      sudo: yes 
    - lineinfile: dest=/opt/{{ jboss_version }}/standalone/configuration/application-users.properties backrefs=yes regexp='^tsruser' line='tsruser=dc1be3ff2bdeb5ea38e6e1f435bcea69' state=present
      sudo: yes 
    - lineinfile: dest=/opt/{{ jboss_version }}/standalone/configuration/application-roles.properties backrefs=yes regexp='^tsruser' line='tsruser=Admin' state=present
      sudo: yes 
    - lineinfile: dest=/opt/{{ jboss_version }}/standalone/configuration/teiid-security-users.properties backrefs=yes regexp='^user' line='user=tsruserpw' state=present
      sudo: yes 
      